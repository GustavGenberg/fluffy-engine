<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
		input[name='ServerConsole'] {
			border: 1px solid #a3a3a3;
			position: fixed;
			bottom: 10px;
			right: 10px;
			padding: 10px 15px;
			font-size: 25px;
			outline: none;
			border-radius: 5px;
			color: #333333;
		}
	</style>
</head>
<body>

<script type="text/javascript" src="/socket.io/socket.io.js"></script>

<input type="checkbox" id="prediction" onchange="javascript:updateConfig();">Prediction</input> Â· <input type="checkbox" id="reconciliation" onchange="javascript:updateConfig();">Reconciliation</input> . <input type="checkbox" id="serverstate" onchange="javascript:updateConfig();">Server State</input> 

<canvas id="Game"></canvas>

<input type="text" id="ServerConsole" name="ServerConsole" placeholder="Server Console">


<script type="text/javascript">
		
	var socket = io('/');

	var Config = {
		Server: {
			show_server_pos: false,
		},
		Prediction: false,
		Reconciliation: false
	};

	var updateConfig = function () {

		var cb_prediction = document.getElementById("prediction");
  	var cb_reconciliation = document.getElementById("reconciliation");
  	var cb_serverstate = document.getElementById("serverstate");

  	Config.Prediction = cb_prediction.checked;
  	Config.Reconciliation = cb_reconciliation.checked;
  	Config.Server.show_server_pos = cb_serverstate.checked;

	};

	document.getElementById('ServerConsole').onchange = function () {

		var value = this.value;

		var cmd = value.split(' ')[0];
		var val = value.split(' ')[1];

		this.value = '';

		if(!cmd || !val) return;

		Network.Send('cmd', [cmd, val]);
		console.log(' :: Command :: Sent to following command to server: { Cmd: ' + cmd + ', Val: ' + val + ' }');

	};

	var canvas = document.getElementById('Game');
	canvas.width = 500;
	canvas.height = 500;
	canvas.style.border = '1px dotted grey';

	var ctx = canvas.getContext('2d');

	var _now = function () { return +new Date }

	var Server = function () {

		console.log('Server Networking Init');

		this.Messages = [];

		// Socket Messages

		var _this = this;

		socket.on('Connected', function (Data) {

			client.entity_id = Data.entity_id;

		});

		socket.on('serverstate', function (Data) {

			_this.Messages.push({
				timestamp: _now(),
				payload: Data
			});

		});


	};

	Server.prototype.getMessages = function () {
		var now = _now();

		for ( var i = 0; i < this.Messages.length; i++ ) {
			var message = this.Messages[i];

			if(message.timestamp <= now) {
				this.Messages.splice(i, 1);
				return message.payload;
			}

		}
	};

	Server.prototype.Send = function(Packet, Val) {

		socket.emit(Packet, Val);
	
	};

	var Network = new Server();

	var Entity = function () {
		this.x = 0;
		this.y = 0;

		this.server = { };

		this.server.x = 0;
		this.server.y = 0;
		this.server.speed = 0;

		this.speed = 0;
	};

	Entity.prototype.applyInput = function (input) {
		if([37, 39].indexOf(input.key) > -1) {
			this.x += input.press_time*this.speed;
		}
		if([38, 40].indexOf(input.key) > -1) {
			this.y += input.press_time*this.speed;
		}
	};

	

	var Client = function () {

		this.entity = null;
		this.entity_id = null;

		this.key_left = false;
		this.key_right = false;

		this.socket = io;
		this.server = null;

		// reconciliation

		this.input_sequence_number = 0;
		this.pending_inputs = [];

	};

	Client.prototype.update = function () {

		this.processServerMessages();

		if(this.entity == null) return;

		this.processInputs();

		RenderWorld ([this.entity]) ;

	};

	Client.prototype.processInputs = function() {
		
		var now = _now();

		var last_ts = this.last_ts || now;
		var delta_sec = (now - last_ts) / 1000.0;
		this.last_ts = now;

		// console.log(1.0 / delta_sec);


		var input;

		if(this.key_right) {
			input = {
				press_time: delta_sec,
				key: 37
			}
		} else if(this.key_left) {
			input = {
				press_time: -delta_sec,
				key: 39
			}
		} else if(this.key_up) {
			input = {
				press_time: -delta_sec,
				key: 38
			}
		} else if(this.key_down) {
			input = {
				press_time: delta_sec,
				key: 40
			}
		} else {

			return;
		
		}

		input.input_sequence_number = this.input_sequence_number++;
		input.entity_id = this.entity_id;

		Network.Send('Key', input);

		if(Config.Prediction) {
			this.entity.applyInput(input);
		}

		this.pending_inputs.push(input);

	};

	Client.prototype.processServerMessages = function () {

		while ( true ) {

			var message = Network.getMessages();
			//console.log(message);


			if(!message) break;

			for ( var i = 0; i < message.length; i++ ) {
				var state = message[i];


				if( state.entity_id == this.entity_id ) {

					//console.log('hola');

					if(!this.entity) {
						this.entity = new Entity ();
					}

					this.entity.x = state.x;
					this.entity.y = state.y;
					this.entity.speed = state.speed;
					this.entity.entity_id = state.entity_id;

					this.entity.server.x = state.x;
					this.entity.server.y = state.y;
					this.entity.server.speed = state.speed;

					if(Config.Reconciliation) {

						var j = 0;

						while ( j < this.pending_inputs.length ) {

							var input = this.pending_inputs[j];

							if(input.input_sequence_number <= state.last_processed_input) {

								this.pending_inputs.splice(j, 1);

							} else {

								this.entity.applyInput(input);
								j++;

							}

						}

					} else {

						this.pending_inputs = [];

					}

				} else {

					// Other Entity

				}
			}

		}

	};

	var RenderWorld = function (Entities) {

		ctx.clearRect(0, 0, 500, 500);

		for ( var i = 0; i < Entities.length; i++ ) {

			var entity = Entities[i];

			ctx.beginPath();


			// Server Player

			if(Config.Server.show_server_pos) {
				ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
				ctx.fillRect(entity.server.x, entity.server.y, 15, 15);
			}

			// Local Player

			ctx.fillStyle = 'rgba(235, 189, 51, 0.9)';
			ctx.fillRect(entity.x, entity.y, 20, 20);


			ctx.fillText(entity.entity_id, entity.x, entity.y + 35);

			ctx.closePath();

		}
	};

	var client = new Client();

	var updateClient = function() {
  	client.update();
	}

	document.addEventListener('keydown', function (Event) {
		if(Event.keyCode == 13) {
			document.getElementById('ServerConsole').focus();
		}

		if(Event.keyCode == 37) {

			client.key_left = true;

		} else if (Event.keyCode == 38) {

			client.key_up = true;

		} else if (Event.keyCode == 39) {

			client.key_right = true;

		} else if (Event.keyCode == 40) {

			client.key_down = true;

		}
	});

	document.addEventListener('keyup', function (Event) {
		if(Event.keyCode == 37) {
			client.key_left = false;
		} else if (Event.keyCode == 38) {
			client.key_up = false;
		} else if (Event.keyCode == 39) {
			client.key_right = false;
		} else if (Event.keyCode == 40) {
			client.key_down = false;
		}
	});

	setInterval(function () {
		updateClient();
	}, 1000 / 0);

</script>

</body>
</html>